name: Build Android TV App

on:
  push:
    branches: [ main, develop, fix/compile-errors ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Setup hiddify-core dependency
      run: |
        echo "ğŸ“¥ Setting up hiddify-core dependency..."
        
        # Crear directorio libcore si no existe
        mkdir -p libcore
        
        # Verificar si ya existe contenido en libcore
        if [ -d "libcore" ] && [ "$(ls -A libcore)" ]; then
          echo "âœ… libcore directory already has content"
          ls -la libcore/ | head -5
        else
          echo "ğŸ“¥ Downloading hiddify-core..."
          
          # Intentar descargar hiddify-core
          download_success=false
          
          # MÃ©todo 1: Git clone
          if ! $download_success; then
            echo "ğŸ”„ Trying git clone..."
            if git clone --depth 1 https://github.com/hiddify/hiddify-core.git temp-hiddify-core; then
              cp -r temp-hiddify-core/* libcore/ 2>/dev/null || true
              rm -rf temp-hiddify-core
              download_success=true
              echo "âœ… Git clone successful"
            fi
          fi
          
          # MÃ©todo 2: Wget tar.gz
          if ! $download_success; then
            echo "ğŸ”„ Trying wget tar.gz..."
            if wget -q --timeout=30 -O hiddify-core.tar.gz \
               "https://github.com/hiddify/hiddify-core/archive/refs/heads/main.tar.gz"; then
              tar -xzf hiddify-core.tar.gz
              if [ -d "hiddify-core-main" ]; then
                cp -r hiddify-core-main/* libcore/ 2>/dev/null || true
                download_success=true
                echo "âœ… Wget tar.gz successful"
              fi
              rm -rf hiddify-core.tar.gz hiddify-core-main
            fi
          fi
          
          # MÃ©todo 3: Curl fallback
          if ! $download_success; then
            echo "ğŸ”„ Trying curl fallback..."
            if curl -L --max-time 120 \
               "https://github.com/hiddify/hiddify-core/archive/refs/heads/main.tar.gz" \
               -o hiddify-core.tar.gz; then
              tar -xzf hiddify-core.tar.gz 2>/dev/null || true
              if [ -d "hiddify-core-main" ]; then
                cp -r hiddify-core-main/* libcore/ 2>/dev/null || true
                download_success=true
                echo "âœ… Curl fallback successful"
              fi
              rm -rf hiddify-core.tar.gz hiddify-core-main
            fi
          fi
          
          # Verificar resultado
          if [ -d "libcore" ] && [ "$(ls -A libcore)" ]; then
            echo "âœ… hiddify-core setup completed"
          else
            echo "âš ï¸ hiddify-core download failed, creating minimal structure..."
            mkdir -p libcore
            echo "# Placeholder for hiddify-core" > libcore/README.md
          fi
        fi
        
        echo "ğŸ“Š libcore directory status:"
        ls -la libcore/ | head -10

    - name: Fix dependencies and prepare pubspec.yaml
      run: |
        echo "ğŸ”§ Checking and fixing dependencies..."
        
        if [ -f "pubspec.yaml" ]; then
          echo "âœ… Found pubspec.yaml"
          
          # Hacer backup
          cp pubspec.yaml pubspec.yaml.backup
          
          # Verificar si existe tv_focus (que no es un paquete real)
          if grep -q "tv_focus" pubspec.yaml; then
            echo "âš ï¸ Found tv_focus dependency - this package doesn't exist"
            echo "ğŸ”§ Removing tv_focus dependency..."
            sed -i '/tv_focus/d' pubspec.yaml
            echo "âœ… Removed tv_focus dependency"
          fi
          
          # Verificar otras dependencias problemÃ¡ticas
          echo "ğŸ” Checking for other potential issues..."
          
          # Mostrar dependencias principales
          echo "ğŸ“‹ Current dependencies:"
          grep -A 20 "dependencies:" pubspec.yaml | head -25
          
        else
          echo "âŒ pubspec.yaml not found!"
          exit 1
        fi

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        accept-android-sdk-licenses: true

    - name: Install Android SDK components
      run: |
        echo "ğŸ“± Installing required Android SDK components..."
        
        # Verificar ANDROID_HOME
        if [ -z "$ANDROID_HOME" ]; then
          export ANDROID_HOME=$ANDROID_SDK_ROOT
        fi
        
        echo "ANDROID_HOME: $ANDROID_HOME"
        
        # Instalar componentes necesarios
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-${{ env.ANDROID_API_LEVEL }}" \
          "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
          "platform-tools" \
          "extras;android;m2repository" \
          "extras;google;m2repository"
        
        echo "âœ… Android SDK components installed"

    - name: Accept Android SDK licenses
      run: |
        echo "ğŸ“„ Accepting Android SDK licenses..."
        yes | flutter doctor --android-licenses || true

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Get Flutter dependencies
      run: |
        echo "ğŸ“¦ Getting Flutter dependencies..."
        
        # Limpiar cache si es necesario
        flutter clean
        
        # Obtener dependencias
        flutter pub get
        
        echo "âœ… Flutter dependencies installed"

    - name: Run Flutter doctor
      run: |
        echo "ğŸ” Running Flutter doctor..."
        flutter doctor -v
        
        echo "ğŸ”§ Flutter version info:"
        flutter --version

    - name: Verify project structure
      run: |
        echo "ğŸ“ Verifying project structure..."
        
        echo "ğŸ“‹ Project root contents:"
        ls -la
        
        echo "ğŸ“± Android directory structure:"
        if [ -d "android" ]; then
          find android -name "*.gradle" -o -name "AndroidManifest.xml" | head -10
        else
          echo "âŒ No android directory found"
        fi
        
        echo "ğŸ“‚ Lib directory structure:"
        if [ -d "lib" ]; then
          find lib -name "*.dart" | head -10
        else
          echo "âŒ No lib directory found"
        fi

    - name: Prepare build environment
      run: |
        echo "ğŸš€ Preparing build environment..."
        
        # Configurar variables de entorno
        export FLUTTER_BUILD_MODE=release
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export GRADLE_OPTS="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"
        
        echo "ğŸ”§ Build environment variables:"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "JAVA_HOME: $JAVA_HOME"
        echo "GRADLE_OPTS: $GRADLE_OPTS"
        
        # Verificar espacio en disco
        echo "ğŸ’¾ Available disk space:"
        df -h

    - name: Build Android APK
      run: |
        echo "ğŸ”¨ Building Android APK..."
        
        # Configurar variables de entorno
        export FLUTTER_BUILD_MODE=release
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export GRADLE_OPTS="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"
        
        # Estrategia de build mÃºltiple
        build_success=false
        
        # Intento 1: Build estÃ¡ndar
        if ! $build_success; then
          echo "ğŸ”„ Attempting standard build..."
          if flutter build apk --release --target-platform android-arm64; then
            build_success=true
            echo "âœ… Standard build successful"
          else
            echo "âŒ Standard build failed"
          fi
        fi
        
        # Intento 2: Build con split-per-abi
        if ! $build_success; then
          echo "ğŸ”„ Attempting build with split-per-abi..."
          if flutter build apk --release --split-per-abi; then
            build_success=true
            echo "âœ… Split-per-abi build successful"
          else
            echo "âŒ Split-per-abi build failed"
          fi
        fi
        
        # Intento 3: Build solo para arm64
        if ! $build_success; then
          echo "ğŸ”„ Attempting arm64-only build..."
          if flutter build apk --release --target-platform android-arm64 --dart-define=FLUTTER_WEB_USE_SKIA=true; then
            build_success=true
            echo "âœ… ARM64-only build successful"
          else
            echo "âŒ ARM64-only build failed"
          fi
        fi
        
        # Verificar si el build fue exitoso
        if ! $build_success; then
          echo "âŒ All build attempts failed!"
          echo "ğŸ” Checking for build errors..."
          
          # Buscar logs de error
          if [ -f "android/app/build/outputs/logs/manifest-merger-debug-report.txt" ]; then
            echo "ğŸ“„ Manifest merger report:"
            cat android/app/build/outputs/logs/manifest-merger-debug-report.txt
          fi
          
          # Intentar build verbose como Ãºltimo recurso
          echo "ğŸ”„ Final attempt with verbose output..."
          flutter build apk --release --verbose
        fi

    - name: Locate and verify built APKs
      run: |
        echo "ğŸ” Locating built APK files..."
        
        # Buscar todos los APKs
        echo "ğŸ“± Searching for APK files..."
        apk_files=$(find . -name "*.apk" -type f 2>/dev/null || true)
        
        if [ -n "$apk_files" ]; then
          echo "âœ… Found APK files:"
          echo "$apk_files" | while read -r apk; do
            if [ -f "$apk" ]; then
              size=$(ls -lh "$apk" | awk '{print $5}')
              echo "ğŸ“± $apk (Size: $size)"
              
              # Verificar que sea un APK vÃ¡lido
              if file "$apk" | grep -q "Android\|ZIP"; then
                echo "   âœ… Valid APK file"
              else
                echo "   âš ï¸ Potentially invalid APK"
              fi
            fi
          done
          
          # Mostrar estructura de build outputs
          echo ""
          echo "ğŸ“‚ Build outputs structure:"
          if [ -d "build/app/outputs" ]; then
            find build/app/outputs -name "*.apk" -ls
          fi
          
        else
          echo "âŒ No APK files found!"
          echo "ğŸ” Checking build directories..."
          find . -type d -name "*outputs*" -o -name "*apk*" | head -10
          
          echo "ğŸ“‚ Build directory contents:"
          if [ -d "build" ]; then
            find build -name "*.apk" -o -name "*.aab" | head -10
          fi
        fi

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hiddify-android-apk-${{ github.run_number }}
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/apk/**/*.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build/
          android/app/build/
          android/build/
          ~/.gradle/daemon/
          flutter_*.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Build summary
      if: always()
      run: |
        echo "ğŸ Build Summary"
        echo "==============="
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ”¢ Run: ${{ github.run_number }}"
        echo "â° Date: $(date)"
        echo ""
        
        if [ -d "build/app/outputs" ]; then
          echo "ğŸ“± Generated APKs:"
          find build/app/outputs -name "*.apk" -exec basename {} \; | sort
          echo ""
          echo "ğŸ“Š APK sizes:"
          find build/app/outputs -name "*.apk" -exec ls -lh {} \; | awk '{print $5 " " $9}'
        else
          echo "âŒ No build outputs found"
        fi
        
        echo ""
        echo "ğŸ”— Download artifacts from the Actions tab above"

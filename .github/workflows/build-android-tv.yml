name: Build Android TV App

on:
  push:
    branches: [ main, develop, fix/compile-errors ]  # âœ… Incluye tu rama
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # âœ… Permite ejecuciÃ³n manual desde GitHub UI

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 1

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Download hiddify-core manually
      run: |
        echo "ğŸ“¥ Downloading hiddify-core manually..."
        
        # Crear directorio libcore si no existe
        mkdir -p libcore
        
        # FunciÃ³n para verificar si el directorio tiene contenido Ãºtil
        check_libcore_content() {
          if [ -d "libcore" ] && [ "$(ls -A libcore)" ]; then
            echo "âœ… libcore directory has content"
            return 0
          else
            echo "âŒ libcore directory is empty or missing"
            return 1
          fi
        }
        
        # Intentar mÃºltiples mÃ©todos de descarga
        download_success=false
        
        # MÃ©todo 1: Descargar como tar.gz
        if ! $download_success; then
          echo "ğŸ”„ Trying tar.gz download..."
          if curl -L --connect-timeout 30 --max-time 300 \
             -H "Accept: application/vnd.github.v3+json" \
             "https://github.com/hiddify/hiddify-core/archive/refs/heads/main.tar.gz" \
             -o hiddify-core.tar.gz; then
            echo "âœ… Downloaded tar.gz successfully"
            if tar -xzf hiddify-core.tar.gz; then
              if [ -d "hiddify-core-main" ]; then
                cp -r hiddify-core-main/* libcore/ 2>/dev/null || true
                cp -r hiddify-core-main/.* libcore/ 2>/dev/null || true
                download_success=true
                echo "âœ… Extracted hiddify-core content"
              fi
            fi
            rm -rf hiddify-core.tar.gz hiddify-core-main
          fi
        fi
        
        # MÃ©todo 2: Descargar como zip
        if ! $download_success; then
          echo "ğŸ”„ Trying zip download..."
          if curl -L --connect-timeout 30 --max-time 300 \
             -H "Accept: application/vnd.github.v3+json" \
             "https://github.com/hiddify/hiddify-core/archive/refs/heads/main.zip" \
             -o hiddify-core.zip; then
            echo "âœ… Downloaded zip successfully"
            if unzip -q hiddify-core.zip; then
              if [ -d "hiddify-core-main" ]; then
                cp -r hiddify-core-main/* libcore/ 2>/dev/null || true
                cp -r hiddify-core-main/.* libcore/ 2>/dev/null || true
                download_success=true
                echo "âœ… Extracted hiddify-core content"
              fi
            fi
            rm -rf hiddify-core.zip hiddify-core-main
          fi
        fi
        
        # MÃ©todo 3: Git clone como alternativa
        if ! $download_success; then
          echo "ğŸ”„ Trying git clone..."
          if git clone --depth 1 https://github.com/hiddify/hiddify-core.git temp-hiddify-core; then
            cp -r temp-hiddify-core/* libcore/ 2>/dev/null || true
            cp -r temp-hiddify-core/.* libcore/ 2>/dev/null || true
            rm -rf temp-hiddify-core
            download_success=true
            echo "âœ… Cloned hiddify-core content"
          fi
        fi
        
        # Verificar resultado final
        if check_libcore_content; then
          echo "âœ… hiddify-core setup completed successfully"
        else
          echo "âš ï¸ hiddify-core setup failed, creating minimal structure..."
          mkdir -p libcore
          touch libcore/.gitkeep
          echo "# Placeholder file" > libcore/README.md
        fi
        
        echo "ğŸ“„ Final libcore status:"
        ls -la libcore/ || echo "libcore directory is empty"
        echo "ğŸ“Š Directory size: $(du -sh libcore/ 2>/dev/null || echo 'N/A')"

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        accept-android-sdk-licenses: true

    - name: Install Android SDK components
      run: |
        echo "ğŸ“± Installing Android SDK components..."
        
        # Actualizar SDK manager
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
        
        # Instalar componentes necesarios
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-${{ env.ANDROID_API_LEVEL }}" \
          "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
          "platform-tools" \
          "extras;android;m2repository" \
          "extras;google;m2repository"
        
        echo "âœ… Android SDK components installed"
      run: |
        echo "ğŸ“„ Accepting Android SDK licenses..."
        yes | flutter doctor --android-licenses || true

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ${{ runner.tool_cache }}/flutter
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Fix missing tv_focus dependency
      run: |
        echo "ğŸ”§ Checking for tv_focus dependency issue..."
        
        if grep -q "tv_focus" pubspec.yaml; then
          echo "âš ï¸ Found tv_focus dependency in pubspec.yaml"
          echo "ğŸ“ Current dependencies with tv_focus:"
          grep -A 5 -B 5 "tv_focus" pubspec.yaml || true
          
          # tv_focus no existe en pub.dev, necesitamos reemplazarlo
          echo "âŒ tv_focus package doesn't exist on pub.dev"
          echo "ğŸ”§ Replacing tv_focus with dpad_container (recommended alternative)..."
          
          # Hacer backup del pubspec.yaml original
          cp pubspec.yaml pubspec.yaml.backup
          
          # Reemplazar tv_focus con dpad_container
          sed -i 's/tv_focus.*/dpad_container: ^1.0.0/' pubspec.yaml
          
          echo "âœ… Replaced tv_focus with dpad_container"
          echo "ğŸ“„ Updated dependencies section:"
          grep -A 10 "dependencies:" pubspec.yaml || true
          
          # TambiÃ©n verificar imports en el cÃ³digo
          echo "ğŸ” Checking for tv_focus imports in code..."
          if find lib -name "*.dart" -exec grep -l "tv_focus" {} \; 2>/dev/null; then
            echo "âš ï¸ Found tv_focus imports in code files"
            echo "ğŸ“ Files that need manual import updates:"
            find lib -name "*.dart" -exec grep -l "tv_focus" {} \; 2>/dev/null || true
            echo "ğŸ’¡ Note: You'll need to update these imports from 'tv_focus' to 'dpad_container'"
          fi
          
        else
          echo "âœ… No tv_focus dependency found in pubspec.yaml"
        fi
        
        echo ""
        echo "ğŸ” Checking for other common TV focus packages..."
        if grep -q "dpad_container\|simple_tv_navigation\|focus_on_it" pubspec.yaml; then
          echo "âœ… Found existing TV focus packages:"
          grep "dpad_container\|simple_tv_navigation\|focus_on_it" pubspec.yaml || true
        else
          echo "ğŸ’¡ No TV focus packages found. Consider adding:"
          echo "   - dpad_container: ^1.0.0"
          echo "   - simple_tv_navigation: ^1.0.0"
        fi
      run: |
        echo "ğŸ“¦ Getting Flutter dependencies..."
        flutter pub get
        
        echo "ğŸ” Checking pubspec.yaml dependencies..."
        if [ -f "pubspec.yaml" ]; then
          echo "Dependencies found in pubspec.yaml:"
          grep -A 20 "dependencies:" pubspec.yaml || true
        fi

    - name: Check Flutter doctor
      run: |
        echo "ğŸ” Checking Flutter setup..."
        flutter doctor -v
        
        echo "ğŸ”§ Flutter version info:"
        flutter --version

    - name: Verify Android configuration
      run: |
        echo "ğŸ” Verifying Android configuration..."
        
        if [ -f "android/app/build.gradle" ]; then
          echo "âœ… Found android/app/build.gradle"
          echo "ğŸ“„ Checking for TV configuration..."
          grep -n "tv\|leanback" android/app/build.gradle || echo "No TV-specific configuration found"
        else
          echo "âŒ android/app/build.gradle not found"
        fi
        
        if [ -d "android/app/src/main" ]; then
          echo "âœ… Found android/app/src/main"
          find android/app/src -name "AndroidManifest.xml" -exec echo "Found manifest: {}" \;
        fi

    - name: Pre-build diagnostics
      run: |
        echo "ğŸ” Pre-build diagnostics..."
        
        echo "ğŸ“Š Project structure:"
        ls -la
        
        echo "ğŸ“± Android directory structure:"
        find android -type f -name "*.gradle" -o -name "*.xml" | head -10
        
        echo "ğŸ¯ Flutter build environment:"
        flutter config
        
        echo "ğŸ’¾ Available disk space:"
        df -h

    - name: Build Android APK
      run: |
        echo "ğŸš€ Building Android APK..."
        
        # Establecer variables de entorno para el build
        export FLUTTER_BUILD_MODE=release
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        
        echo "ğŸ”§ Build environment:"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "JAVA_HOME: $JAVA_HOME"
        
        # Intentar build con diferentes estrategias
        build_success=false
        
        # Estrategia 1: Build estÃ¡ndar
        if ! $build_success; then
          echo "ğŸ”„ Attempting standard build..."
          if flutter build apk --release --target-platform android-arm64; then
            build_success=true
            echo "âœ… Standard build successful"
          else
            echo "âŒ Standard build failed"
          fi
        fi
        
        # Estrategia 2: Build con mÃ¡s memoria
        if ! $build_success; then
          echo "ğŸ”„ Attempting build with increased memory..."
          export GRADLE_OPTS="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"
          if flutter build apk --release --target-platform android-arm64; then
            build_success=true
            echo "âœ… Build with increased memory successful"
          else
            echo "âŒ Build with increased memory failed"
          fi
        fi
        
        # Estrategia 3: Build verbose para diagnÃ³stico
        if ! $build_success; then
          echo "ğŸ”„ Attempting verbose build for diagnostics..."
          flutter build apk --release --target-platform android-arm64 --verbose || {
            echo "âŒ All build attempts failed"
            echo "ğŸ” Collecting error information..."
            
            if [ -f "android/app/build/outputs/logs/manifest-merger-debug-report.txt" ]; then
              echo "ğŸ“„ Manifest merger report:"
              cat android/app/build/outputs/logs/manifest-merger-debug-report.txt
            fi
            
            exit 1
          }
        fi

    - name: Check for TV-specific build
      run: |
        echo "ğŸ“º Checking for Android TV specific configuration..."
        
        # Verificar mÃºltiples indicadores de configuraciÃ³n TV
        tv_config_found=false
        
        # Buscar flavor TV en build.gradle
        if [ -f "android/app/build.gradle" ] && grep -q "tv\|leanback" android/app/build.gradle; then
          echo "âœ… Found TV configuration in build.gradle"
          tv_config_found=true
        fi
        
        # Buscar AndroidManifest.xml especÃ­fico para TV
        if find android/app/src -name "AndroidManifest.xml" -exec grep -l "leanback\|CATEGORY_LEANBACK_LAUNCHER" {} \; | head -1; then
          echo "âœ… Found TV configuration in AndroidManifest.xml"
          tv_config_found=true
        fi
        
        # Buscar directorio tv especÃ­fico
        if [ -d "android/app/src/tv" ]; then
          echo "âœ… Found android/app/src/tv directory"
          tv_config_found=true
        fi
        
        if $tv_config_found; then
          echo "ğŸš€ Building Android TV specific version..."
          
          # Intentar diferentes comandos de build para TV
          tv_build_success=false
          
          # MÃ©todo 1: flavor tv
          if ! $tv_build_success && flutter build apk --release --flavor tv --target-platform android-arm64; then
            tv_build_success=true
            echo "âœ… TV flavor build successful"
          fi
          
          # MÃ©todo 2: target especÃ­fico si existe
          if ! $tv_build_success && [ -f "lib/main_tv.dart" ]; then
            if flutter build apk --release -t lib/main_tv.dart --target-platform android-arm64; then
              tv_build_success=true
              echo "âœ… TV target build successful"
            fi
          fi
          
          if ! $tv_build_success; then
            echo "âš ï¸ TV-specific build failed, but standard build should be available"
          fi
        else
          echo "ğŸ“± No TV-specific configuration found, using standard Android build"
        fi

    - name: List and verify generated APKs
      run: |
        echo "ğŸ“‹ Searching for generated APK files..."
        
        # Buscar todos los APKs generados
        apk_files=$(find . -name "*.apk" -type f 2>/dev/null || true)
        
        if [ -n "$apk_files" ]; then
          echo "âœ… Found APK files:"
          echo "$apk_files" | while read -r apk; do
            if [ -f "$apk" ]; then
              size=$(ls -lh "$apk" | awk '{print $5}')
              echo "  ğŸ“± $apk (Size: $size)"
              
              # Verificar que el APK no estÃ© corrupto
              if file "$apk" | grep -q "Android"; then
                echo "    âœ… Valid Android APK"
              else
                echo "    âš ï¸ Potentially invalid APK"
              fi
            fi
          done
        else
          echo "âŒ No APK files found!"
          echo "ğŸ” Checking build output directories..."
          find . -type d -name "*apk*" -o -name "*outputs*" | head -10
        fi
        
        echo ""
        echo "ğŸ“Š Build output summary:"
        du -sh build/ 2>/dev/null || echo "No build directory found"

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-tv-apk-${{ github.run_number }}-${{ github.ref_name }}
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/apk/**/*.apk
        retention-days: 30

    - name: Upload build logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}-${{ github.ref_name }}
        path: |
          build/
          android/app/build/
          android/build/
          ~/.gradle/daemon/
          *.log
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Build summary
      if: always()
      run: |
        echo "ğŸ Build Summary"
        echo "==============="
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Run number: ${{ github.run_number }}"
        echo ""
        
        if [ -d "build/app/outputs" ]; then
          echo "ğŸ“± Generated artifacts:"
          find build/app/outputs -name "*.apk" -exec basename {} \; | sort | uniq
        else
          echo "âŒ No build outputs found"
        fi
